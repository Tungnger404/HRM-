<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <title>Payroll List</title>
</head>

<body>
<div layout:fragment="content">

    <!-- ✅ Alert đổi màu theo msgType -->
    <div th:if="${msg != null}"
         th:class="'alert alert-' + (${msgType} != null ? ${msgType} : 'success')">
        <span th:text="${msg}"></span>
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <form method="get" th:action="@{/manager/payroll/payslips}"
                  class="d-flex gap-2 align-items-center flex-wrap">
                <input class="form-control" style="max-width:320px"
                       name="q" th:value="${q}" placeholder="Search"/>

                <select class="form-select" style="max-width:220px" name="status">
                    <option th:each="op : ${statusOptions}"
                            th:value="${op}"
                            th:selected="${op == status}"
                            th:text="${op == '' ? 'All Status' : op}">
                    </option>
                </select>

                <button class="btn btn-primary" type="submit">Search</button>
            </form>
        </div>
    </div>

    <form id="bulkForm" method="post" th:action="@{/manager/payroll/payslips/bulk}">
        <div th:if="${_csrf != null}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        </div>

        <input type="hidden" name="action" id="bulkAction"/>

        <div class="d-flex gap-2 mb-2">
            <button class="btn btn-success" type="button" id="btnApprove">Approve</button>
            <button class="btn btn-danger" type="button" id="btnReject">Reject</button>
        </div>

        <div class="card">
            <div class="card-body table-responsive">
                <table class="table table-bordered table-hover align-middle">
                    <thead>
                    <tr>
                        <th style="width:90px" class="text-center">
                            <input class="form-check-input" type="checkbox" id="checkAll">
                            <label for="checkAll" class="ms-1">All</label>
                        </th>

                        <th style="width:60px">Stt</th>
                        <th>Mã NV</th>
                        <th>Name</th>

                        <th>Vị trí</th>
                        <th class="text-end">Lương vị trí</th>
                        <th class="text-end">Lương ngày</th>

                        <th>Kỳ lương</th>
                        <th>Thời gian</th>
                        <th class="text-end">Tổng lương (Net)</th>
                        <th>Trạng thái</th>
                        <th style="width:90px">Xem</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="r,st : ${rows}"
                        th:classappend="${r.batchStatus != 'PENDING_APPROVAL'} ? 'text-muted' : ''">

                        <td class="text-center">
                            <!-- ✅ Chỉ cho chọn PENDING_APPROVAL -->
                            <input type="checkbox"
                                   class="row-check"
                                   name="batchIds"
                                   th:value="${r.batchId}"
                                   th:disabled="${r.batchStatus != 'PENDING_APPROVAL'}">
                        </td>

                        <td th:text="${st.index + 1}"></td>
                        <td th:text="${r.empCode}"></td>
                        <td th:text="${r.fullName}"></td>

                        <td th:text="${r.jobTitle}"></td>

                        <td class="text-end"
                            th:text="${r.baseSalary == null ? '0' : #numbers.formatDecimal(r.baseSalary, 1, 'COMMA', 0, 'POINT')}"></td>

                        <td class="text-end"
                            th:text="${r.dailySalary == null ? '0' : #numbers.formatDecimal(r.dailySalary, 1, 'COMMA', 0, 'POINT')}"></td>

                        <td>
                            <span th:text="${r.month}"></span>/<span th:text="${r.year}"></span>
                        </td>

                        <td>
                            <span th:text="${r.startDate != null ? #temporals.format(r.startDate, 'dd/MM/yyyy') : ''}"></span>
                            -
                            <span th:text="${r.endDate != null ? #temporals.format(r.endDate, 'dd/MM/yyyy') : ''}"></span>
                        </td>

                        <td class="text-end"
                            th:text="${r.netSalary == null ? '0' : #numbers.formatDecimal(r.netSalary, 1, 'COMMA', 0, 'POINT')}"></td>

                        <td th:text="${r.statusLabel}"></td>
                        <td>
                            <a class="btn btn-sm btn-outline-primary"
                               th:href="@{/manager/payroll/payslips/{id}(id=${r.payslipId})}">
                                View
                            </a>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(rows)}">
                        <td colspan="12" class="text-center text-body-secondary">Chưa có dữ liệu payslips</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </form>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("bulkForm");
            const checkAll = document.getElementById("checkAll");
            const bulkAction = document.getElementById("bulkAction");
            const btnApprove = document.getElementById("btnApprove");
            const btnReject = document.getElementById("btnReject");

            const rowChecks = () => Array.from(document.querySelectorAll(".row-check"));
            const enabledChecks = () => rowChecks().filter(cb => !cb.disabled);

            function selectedUniqueBatchCount() {
                const set = new Set();
                rowChecks().forEach(cb => {
                    if (!cb.disabled && cb.checked) set.add(cb.value);
                });
                return set.size;
            }

            checkAll?.addEventListener("change", function () {
                enabledChecks().forEach(cb => cb.checked = checkAll.checked);
            });

            document.addEventListener("change", function (e) {
                if (e.target.classList && e.target.classList.contains("row-check")) {
                    const checks = enabledChecks();
                    const allChecked = checks.length > 0 && checks.every(cb => cb.checked);
                    if (checkAll) checkAll.checked = allChecked;
                }
            });

            function submitBulk(actionName) {
                const count = selectedUniqueBatchCount();
                if (count === 0) {
                    alert("Bạn chỉ có thể chọn dòng đang ở trạng thái PENDING.");
                    return;
                }

                const msg = actionName === "approve"
                    ? `Bạn có chắc muốn APPROVE ${count} batch đã chọn không?`
                    : `Bạn có chắc muốn REJECT ${count} batch đã chọn không?`;

                if (!confirm(msg)) return;

                bulkAction.value = actionName;
                form.submit();
            }

            btnApprove?.addEventListener("click", () => submitBulk("approve"));
            btnReject?.addEventListener("click", () => submitBulk("reject"));
        });
    </script>

</div>
</body>
</html>